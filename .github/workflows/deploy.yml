name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'railway'
        type: choice
        options:
          - railway
          - render
          - dockerhub

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    environment: production
    concurrency:
      group: production-backend
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./src/backend
          push: true
          tags: ghcr.io/${{ github.repository }}:backend-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Railway (Backend)
        if: github.event.inputs.environment == 'railway' || github.event_name == 'push'
        run: |
          # Install Railway CLI
          npm i -g @railway/cli

          # Login (requires RAILWAY_TOKEN in secrets)
          railway login --token=${{ secrets.RAILWAY_TOKEN }}

          # Link to project
          railway link --project=${{ secrets.RAILWAY_PROJECT_ID }}

          # Set environment variables
          railway variables set DATABASE_URL=${{ secrets.DATABASE_URL }}
          railway variables set JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          railway variables set BACKEND_CORS_ORIGINS=${{ secrets.BACKEND_CORS_ORIGINS }}

          # Deploy
          railway up

      - name: Deploy to Render (Backend)
        if: false  # Enable if using Render
        run: |
          # Render deployment requires Render CLI or API
          echo "Configure Render deployment here"
          echo "Use render-cli or Render API"

  deploy-frontend:
    runs-on: ubuntu-latest
    environment: production
    concurrency:
      group: production-frontend
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./src/frontend
          push: true
          tags: ghcr.io/${{ github.repository }}:frontend-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Railway (Frontend)
        if: github.event.inputs.environment == 'railway' || github.event_name == 'push'
        run: |
          npm i -g @railway/cli
          railway login --token=${{ secrets.RAILWAY_TOKEN }}
          railway link --project=${{ secrets.RAILWAY_PROJECT_ID }}

          railway variables set NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          railway up

      - name: Deploy to Render (Frontend)
        if: false  # Enable if using Render
        run: |
          echo "Configure Render frontend deployment here"

  notify:
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: Send notification
        if: failure()
        run: |
          echo "Deployment failed! Check GitHub Actions logs for details."
          # Add Slack/Discord/email notification here
          # Example for Slack:
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"Deployment failed! ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
